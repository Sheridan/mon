# %Id%
PROJECT(mon)
CMAKE_MINIMUM_REQUIRED(VERSION 2.6)

OPTION( BUILD_COLLECTOR      "Build collector"                        OFF )
OPTION( BUILD_NODE           "Build node"                             ON  )
OPTION( BUILD_CLIENT_QT      "Build Qt client"                        OFF )
OPTION( BUILD_CLIENT_NCURSES "Build mon-client-qt"                    OFF )

SET(LIB_PREFIX_TARGET  "lib/mon"                     )
SET(LIB_GLOBAL_TARGET  "${LIB_PREFIX_TARGET}/global" )
SET(LIB_SENSORS_TARGET "${LIB_PREFIX_TARGET}/sensors")

include(CMakeDebug.cmake)
install(FILES CMakeDebug.cmake DESTINATION include/mon)
install(FILES CMakeSensor.cmake DESTINATION include/mon)

MESSAGE( STATUS "---> Processing base" )

set( GEN_PATH "${PROJECT_BINARY_DIR}/mon_generated_sources" )
file(MAKE_DIRECTORY ${GEN_PATH})
file(WRITE  ${GEN_PATH}/generated.h "/* Generated by CMake */\n\n#ifndef MON_CMAKE_GENERATED\n#define MON_CMAKE_GENERATED\n\n"  )
file(APPEND ${GEN_PATH}/generated.h "#define MON_GENERATED_LIBRARY_PATH \"${CMAKE_INSTALL_PREFIX}/${LIB_GLOBAL_TARGET}\"\n"  )
file(APPEND ${GEN_PATH}/generated.h "#define MON_GENERATED_SENSORS_PATH \"${CMAKE_INSTALL_PREFIX}/${LIB_SENSORS_TARGET}\"\n" )
file(APPEND ${GEN_PATH}/generated.h "\n#endif\n" )

# +++++++++++++++++++ tools +++++++++++++++++++
MESSAGE ( STATUS "---> Processing tools" )
add_executable( mon-text-to-char-array tools/mon-text-to-char-array/main.cpp)
install(TARGETS mon-text-to-char-array RUNTIME DESTINATION bin )
# +++++++++++++++++++ tools +++++++++++++++++++


# +++++++++++++++++++ libaryes +++++++++++++++++++

# --------- config library --------------
MESSAGE( STATUS "---> Processing `config` library" )
SET(mon-config-headers
    libraryes/config/src/model/pathinterface.h
    libraryes/config/src/rw/cconfigurationparcer.h
    libraryes/config/src/rw/cconfigurationgenerator.h
    libraryes/config/src/cconfig.h
    libraryes/config/src/model/cnode.h
    libraryes/config/src/model/cfile.h
    libraryes/config/src/model/cfolder.h
    libraryes/config/src/config.h )
SET(mon-config-sources
    libraryes/config/src/main.cpp
    libraryes/config/src/rw/cconfigurationparcer.cpp
    libraryes/config/src/rw/cconfigurationgenerator.cpp
    libraryes/config/src/cconfig.cpp
    libraryes/config/src/model/cnode.cpp
    libraryes/config/src/model/cfile.cpp
    libraryes/config/src/model/cfolder.cpp)
add_library(config SHARED ${mon-config-headers} ${mon-config-sources})
install(FILES ${mon-config-headers} DESTINATION include/mon )
install(TARGETS config LIBRARY DESTINATION ${LIB_GLOBAL_TARGET})

# --------- logger library --------------
MESSAGE ( STATUS "---> Processing `logger` library" )
SET(mon-logger-headers
    libraryes/logger/src/logger.h
    libraryes/logger/src/clogmessage.h
    libraryes/logger/src/clogger.h  )
SET(mon-logger-sources
    libraryes/logger/src/main.cpp
    libraryes/logger/src/clogmessage.cpp
    libraryes/logger/src/clogger.cpp )
add_library(logger SHARED ${mon-logger-headers} ${mon-logger-sources})
install(FILES ${mon-logger-headers} DESTINATION include/mon )
install(TARGETS logger LIBRARY DESTINATION ${LIB_GLOBAL_TARGET})

# --------- network library --------------
MESSAGE ( STATUS "---> Processing `network` library" )
SET(mon-network-headers
    libraryes/network/src/csocket.h
    libraryes/network/src/cserversocket.h
    libraryes/network/src/cclientsocket.h )
SET(mon-network-sources
    libraryes/network/src/main.cpp
    libraryes/network/src/csocket.cpp
    libraryes/network/src/cserversocket.cpp
    libraryes/network/src/cclientsocket.cpp )
add_library(network SHARED ${mon-network-headers} ${mon-network-sources})
target_link_libraries(network pthread)
install(FILES ${mon-network-headers} DESTINATION include/mon )
install(TARGETS network LIBRARY DESTINATION ${LIB_GLOBAL_TARGET})

# --------- sensordata library --------------
MESSAGE ( STATUS "---> Processing `sensordata` library" )
SET(mon-sensordata-headers
    libraryes/sensordata/src/data/cdefinition.h
    libraryes/sensordata/src/data/cframe.h
    libraryes/sensordata/src/data/cfrequency.h
    libraryes/sensordata/src/data/cfield.h
    libraryes/sensordata/src/parcers/cdefinitionparcer.h
    libraryes/sensordata/src/parcers/cdefinitiongenerator.h )
SET(mon-sensordata-sources
    libraryes/sensordata/src/data/cdefinition.cpp
    libraryes/sensordata/src/data/cframe.cpp
    libraryes/sensordata/src/data/cfrequency.cpp
    libraryes/sensordata/src/data/cfield.cpp
    libraryes/sensordata/src/parcers/cdefinitionparcer.cpp
    libraryes/sensordata/src/parcers/cdefinitiongenerator.cpp
    libraryes/sensordata/src/main.cpp )
add_library(sensordata SHARED ${mon-sensordata-headers} ${mon-sensordata-sources})
install(TARGETS sensordata LIBRARY DESTINATION ${LIB_GLOBAL_TARGET})

# --------- sensorplugin library --------------
MESSAGE ( STATUS "---> Processing `sensorplugin` library" )
SET(mon-sensorplugin-headers
    libraryes/sensorplugin/src/csensorplugin.h
    libraryes/sensorplugin/src/cframesetbuilder.h)
SET(mon-sensorplugin-sources
    libraryes/sensorplugin/src/csensorplugin.cpp
    libraryes/sensorplugin/src/cframesetbuilder.cpp
    libraryes/sensorplugin/src/main.cpp )
add_library(sensorplugin SHARED ${mon-sensorplugin-headers} ${mon-sensorplugin-sources})
install(FILES ${mon-sensorplugin-headers} DESTINATION include/mon )
install(TARGETS sensorplugin LIBRARY DESTINATION ${LIB_GLOBAL_TARGET})

# --------- protocol library --------------
MESSAGE ( STATUS "---> Processing `protocol` library" )
SET(mon-protocol-headers
    libraryes/protocol/src/cprotocol.h
    libraryes/protocol/src/cnetworkmessage.h)
SET(mon-protocol-sources
    libraryes/protocol/src/cprotocol.cpp
    libraryes/protocol/src/cnetworkmessage.cpp
    libraryes/protocol/src/main.cpp )
add_library(protocol SHARED ${mon-protocol-headers} ${mon-protocol-sources})
install(TARGETS protocol LIBRARY DESTINATION ${LIB_GLOBAL_TARGET})

# --------- base library --------------
MESSAGE ( STATUS "---> Processing `base` library" )
SET(mon-base-headers
    libraryes/base/src/singleton/csingletonmember.h
    libraryes/base/src/singleton/csingleton.h
    libraryes/base/src/cvariant.h
    libraryes/base/src/cstringbuilder.h
    libraryes/base/src/parcer/cparcer.h
    libraryes/base/src/parcer/cparcerfile.h
    libraryes/base/src/parcer/cparcerstring.h
    libraryes/base/src/parcer/stringhelper.h
    libraryes/base/src/parcer/parcer-helper.h)
SET(mon-base-sources
    libraryes/base/src/main.cpp
    libraryes/base/src/singleton/csingletonmember.cpp
    libraryes/base/src/singleton/csingleton.cpp
    libraryes/base/src/cvariant.cpp
    libraryes/base/src/cstringbuilder.cpp
    libraryes/base/src/parcer/cparcer.cpp
    libraryes/base/src/parcer/cparcerfile.cpp
    libraryes/base/src/parcer/cparcerstring.cpp
    libraryes/base/src/parcer/stringhelper.cpp)
add_library(base SHARED ${mon-base-headers} ${mon-base-sources})
install(FILES ${mon-base-headers} DESTINATION include/mon )
install(TARGETS base LIBRARY DESTINATION ${LIB_GLOBAL_TARGET})

# +++++++++++++++++++ libaryes +++++++++++++++++++
# +++++++++++++++++++ install some headers +++++++++++++++++++
install(FILES defines/sensor-defines.h DESTINATION include/mon )
install(FILES defines/logger-helper.h DESTINATION include/mon )
install(FILES defines/file-operations-defines.h DESTINATION include/mon )
install(FILES defines/protocol-control.h DESTINATION include/mon )
# +++++++++++++++++++ install some headers +++++++++++++++++++

# +++++++++++++++++++ applications +++++++++++++++++++
add_dependencies(base config logger network sensordata protocol)
target_link_libraries(base config logger network sensordata protocol)
include_directories( ${GEN_PATH}
                     libraryes/base/src
                     libraryes/base/src/singleton
                     libraryes/base/src/parcer
                     libraryes/network/src
                     libraryes/logger/src
                     libraryes/config/src
                     libraryes/config/src/model
                     libraryes/config/src/rw
                     libraryes/sensordata/src
                     libraryes/sensordata/src/data
                     libraryes/sensordata/src/data/types
                     libraryes/sensordata/src/parcers
                     libraryes/protocol/src
                     defines )

function(add_run target_name)
  file(WRITE ${GEN_PATH}/${target_name}-run "#!/bin/bash\n\nLD_LIBRARY_PATH=\"\${LD_LIBRARY_PATH}:${CMAKE_INSTALL_PREFIX}/${LIB_GLOBAL_TARGET}\" ./${target_name} $@\n\n"  )
  install(FILES ${GEN_PATH}/${target_name}-run
          DESTINATION bin
          PERMISSIONS
            OWNER_READ OWNER_WRITE OWNER_EXECUTE
            GROUP_READ GROUP_EXECUTE
            WORLD_READ WORLD_EXECUTE)
endfunction(add_run)

function(add_daemon target_name)
  add_dependencies(${target_name} base)
  target_link_libraries(${target_name} base)
  install(TARGETS ${target_name} RUNTIME DESTINATION bin )
  add_run(${target_name})
endfunction(add_daemon)

IF( BUILD_COLLECTOR )
  MESSAGE ( STATUS "---> Processing collector" )
  SET(mon-collector-headers
        daemons/collector/src/collector_st.h
        daemons/collector/src/network/cremotenode.h
        daemons/collector/src/network/cremotenodesensor.h
        daemons/collector/src/network/cnodesmanager.h
        daemons/collector/src/network/ccollectorprotocol.h
     )
  SET(mon-collector-sources
      daemons/collector/src/network/cremotenode.cpp
      daemons/collector/src/network/cremotenodesensor.cpp
      daemons/collector/src/network/cnodesmanager.cpp
      daemons/collector/src/network/ccollectorprotocol.cpp
      daemons/collector/src/main.cpp )
  include_directories( daemons/collector/src daemons/collector/src/network )
  add_executable( mon-collector ${mon-collector-headers} ${mon-collector-sources})
  add_daemon(mon-collector)
ENDIF( BUILD_COLLECTOR )

IF( BUILD_NODE )
  MESSAGE ( STATUS "---> Processing node" )
  SET(mon-node-headers
      daemons/node/src/node_st.h
      daemons/node/src/network/ccollectorsmanager.h
      daemons/node/src/network/cremotecollector.h
      daemons/node/src/network/cnodeprotocol.h
      daemons/node/src/sensors/csensor.h
      daemons/node/src/sensors/csensorsmanager.h
  )
  SET(mon-node-sources
      daemons/node/src/network/ccollectorsmanager.cpp
      daemons/node/src/network/cremotecollector.cpp
      daemons/node/src/network/cnodeprotocol.cpp
      daemons/node/src/sensors/csensor.cpp
      daemons/node/src/sensors/csensorsmanager.cpp
      daemons/node/src/main.cpp )
  include_directories( daemons/node/src daemons/node/src/network daemons/node/src/sensors )
  add_executable( mon-node ${mon-node-headers} ${mon-node-sources})
  target_link_libraries(mon-node dl)
  add_daemon(mon-node)

  MESSAGE ( STATUS "---> Processing sensor tester" )
  SET(mon-sensor-test-headers
      daemons/node/src/sensors/csensor.h)
  SET(mon-sensor-test-sources
      daemons/node/src/sensors/csensor.cpp
      tools/mon-sensor-test/main.cpp )
  add_executable(mon-sensor-test ${mon-sensor-test-headers} ${mon-sensor-test-sources})
  target_link_libraries(mon-sensor-test base config logger sensordata dl)
  install(TARGETS mon-sensor-test RUNTIME DESTINATION bin )
  add_run(mon-sensor-test)
ENDIF( BUILD_NODE )
# +++++++++++++++++++ applications +++++++++++++++++++
