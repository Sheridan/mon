# %Id%
PROJECT(mon)
CMAKE_MINIMUM_REQUIRED(VERSION 2.6)

OPTION ( BUILD_COLLECTOR      "Build collector"                           OFF )
OPTION ( BUILD_NODE           "Build node"                             ON  )
OPTION ( BUILD_CLIENT_QT      "Build Qt client"                        OFF )
OPTION ( BUILD_CLIENT_NCURSES "Build mon-client-qt"                    OFF )

SET(LIB_PREFIX_TARGET  "lib/mon"                     )
SET(LIB_GLOBAL_TARGET  "${LIB_PREFIX_TARGET}/global" )
SET(LIB_SENSORS_TARGET "${LIB_PREFIX_TARGET}/sensors")

include(CMakeDebug.cmake)
install(FILES CMakeDebug.cmake DESTINATION include/mon)
install(FILES CMakeSensor.cmake DESTINATION include/mon)

MESSAGE ( STATUS "---> Processing base" )

set( GEN_PATH "${PROJECT_BINARY_DIR}/mon_generated_sources" )
file(MAKE_DIRECTORY ${GEN_PATH})
file(WRITE  ${GEN_PATH}/generated.h "/* Generated by CMake */\n\n#ifndef MON_CMAKE_GENERATED\n#define MON_CMAKE_GENERATED\n\n"  )
file(APPEND ${GEN_PATH}/generated.h "#define MON_GENERATED_LIBRARY_PATH \"${CMAKE_INSTALL_PREFIX}/${LIB_GLOBAL_TARGET}\"\n"  )
file(APPEND ${GEN_PATH}/generated.h "#define MON_GENERATED_SENSORS_PATH \"${CMAKE_INSTALL_PREFIX}/${LIB_SENSORS_TARGET}\"\n" )
file(APPEND ${GEN_PATH}/generated.h "\n#endif\n" )

# +++++++++++++++++++ tools +++++++++++++++++++
MESSAGE ( STATUS "---> Processing tools" )
add_executable( mon-text-to-char-array tools/mon-text-to-char-array/main.cpp)
install(TARGETS mon-text-to-char-array RUNTIME DESTINATION bin )
# +++++++++++++++++++ tools +++++++++++++++++++


# +++++++++++++++++++ libaryes +++++++++++++++++++

# --------- config library --------------
MESSAGE ( STATUS "---> Processing `config` library" )
SET(mon-config-headers
    libraryes/config/src/pathinterface.h
    libraryes/config/src/cparcer.h
    libraryes/config/src/cgenerator.h
    libraryes/config/src/cconfig.h
    libraryes/config/src/cnode.h
    libraryes/config/src/cfile.h
    libraryes/config/src/cfolder.h
    libraryes/config/src/config.h )
SET(mon-config-sources
    libraryes/config/src/main.cpp
    libraryes/config/src/cparcer.cpp
    libraryes/config/src/cgenerator.cpp
    libraryes/config/src/cconfig.cpp
    libraryes/config/src/cnode.cpp
    libraryes/config/src/cfile.cpp
    libraryes/config/src/cfolder.cpp)
add_library(config SHARED ${mon-config-headers} ${mon-config-sources})
install(FILES ${mon-config-headers} DESTINATION include/mon )
install(TARGETS config LIBRARY DESTINATION ${LIB_GLOBAL_TARGET})

# --------- logger library --------------
MESSAGE ( STATUS "---> Processing `logger` library" )
SET(mon-logger-headers
    libraryes/logger/src/logger.h
    libraryes/logger/src/clogmessage.h
    libraryes/logger/src/clogger.h  )
SET(mon-logger-sources
    libraryes/logger/src/main.cpp
    libraryes/logger/src/clogmessage.cpp
    libraryes/logger/src/clogger.cpp )
add_library(logger SHARED ${mon-logger-headers} ${mon-logger-sources})
install(FILES ${mon-logger-headers} DESTINATION include/mon )
install(TARGETS logger LIBRARY DESTINATION ${LIB_GLOBAL_TARGET})

# --------- network library --------------
MESSAGE ( STATUS "---> Processing `network` library" )
SET(mon-network-headers
    libraryes/network/src/csocket.h
    libraryes/network/src/cserversocket.h
    libraryes/network/src/cclientsocket.h )
SET(mon-network-sources
    libraryes/network/src/main.cpp
    libraryes/network/src/csocket.cpp
    libraryes/network/src/cserversocket.cpp
    libraryes/network/src/cclientsocket.cpp )
add_library(network SHARED ${mon-network-headers} ${mon-network-sources})
target_link_libraries(network pthread)
install(FILES ${mon-network-headers} DESTINATION include/mon )
install(TARGETS network LIBRARY DESTINATION ${LIB_GLOBAL_TARGET})

# --------- sensor library --------------
MESSAGE ( STATUS "---> Processing `sensor` library" )
SET(mon-sensor-headers
    libraryes/sensor/src/data/cdefinition.h
    libraryes/sensor/src/data/cinformation.h
    libraryes/sensor/src/data/cstatistics.h
    libraryes/sensor/src/parcers/cdefinitionparcer.h
    libraryes/sensor/src/parcers/cinformationparcer.h
    libraryes/sensor/src/parcers/cstatisticsparcer.h)
SET(mon-sensor-sources
    libraryes/sensor/src/data/cdefinition.cpp
    libraryes/sensor/src/data/cinformation.cpp
    libraryes/sensor/src/data/cstatistics.cpp
    libraryes/sensor/src/parcers/cdefinitionparcer.cpp
    libraryes/sensor/src/parcers/cinformationparcer.cpp
    libraryes/sensor/src/parcers/cstatisticsparcer.cpp
    libraryes/sensor/src/main.cpp )
add_library(sensor SHARED ${mon-sensor-headers} ${mon-sensor-sources})
install(TARGETS sensor LIBRARY DESTINATION ${LIB_GLOBAL_TARGET})

# --------- protocol library --------------
MESSAGE ( STATUS "---> Processing `protocol` library" )
SET(mon-protocol-headers
    libraryes/protocol/src/cprotocol.h
    libraryes/protocol/src/cmessage.h)
SET(mon-protocol-sources
    libraryes/protocol/src/cprotocol.cpp
    libraryes/protocol/src/cmessage.cpp
    libraryes/protocol/src/main.cpp )
add_library(protocol SHARED ${mon-protocol-headers} ${mon-protocol-sources})
install(TARGETS protocol LIBRARY DESTINATION ${LIB_GLOBAL_TARGET})

# --------- base library --------------
MESSAGE ( STATUS "---> Processing `base` library" )
SET(mon-base-headers
    libraryes/base/src/csingletonmember.h
    libraryes/base/src/csingleton.h
    libraryes/base/src/cvariant.h
    libraryes/base/src/cstringbuilder.h )
SET(mon-base-sources
    libraryes/base/src/main.cpp
    libraryes/base/src/csingletonmember.cpp
    libraryes/base/src/csingleton.cpp
    libraryes/base/src/cvariant.cpp
    libraryes/base/src/cstringbuilder.cpp )
add_library(base SHARED ${mon-base-headers} ${mon-base-sources})
install(TARGETS base LIBRARY DESTINATION ${LIB_GLOBAL_TARGET})

# +++++++++++++++++++ libaryes +++++++++++++++++++
# +++++++++++++++++++ install for sensors +++++++++++++++++++
install(FILES defines/sensor-defines.h DESTINATION include/mon )
# +++++++++++++++++++ install for sensors +++++++++++++++++++
# +++++++++++++++++++ applications +++++++++++++++++++
add_dependencies(base config logger network sensor protocol)
target_link_libraries(base config logger network sensor protocol)
include_directories( ${GEN_PATH}
                     libraryes/base/src
                     libraryes/network/src
                     libraryes/logger/src
                     libraryes/config/src
                     libraryes/sensor/src
                     libraryes/sensor/src/data
                     libraryes/sensor/src/parcers
                     libraryes/protocol/src
                     defines )

function(add_run target_name)
  file(WRITE ${GEN_PATH}/${target_name}-run "#!/bin/bash\n\nLD_LIBRARY_PATH=\"\${LD_LIBRARY_PATH}:${CMAKE_INSTALL_PREFIX}/${LIB_GLOBAL_TARGET}\" ./${target_name}\n\n"  )
  install(FILES ${GEN_PATH}/${target_name}-run
          DESTINATION bin
          PERMISSIONS
            OWNER_READ OWNER_WRITE OWNER_EXECUTE
            GROUP_READ GROUP_EXECUTE
            WORLD_READ WORLD_EXECUTE)
endfunction(add_run)

function(add_daemon target_name)
  add_dependencies(${target_name} base)
  target_link_libraries(${target_name} base)
  install(TARGETS ${target_name} RUNTIME DESTINATION bin )
  add_run(${target_name})
endfunction(add_daemon)

IF( BUILD_COLLECTOR )
  MESSAGE ( STATUS "---> Processing collector" )
  SET(mon-collector-headers
        daemons/collector/src/collector_st.h
        daemons/collector/src/network/cremotenode.h
        daemons/collector/src/network/cnodesmanager.h
        daemons/collector/src/network/ccollectorprotocol.h
     )
  SET(mon-collector-sources
      daemons/collector/src/network/cremotenode.cpp
      daemons/collector/src/network/cnodesmanager.cpp
      daemons/collector/src/network/ccollectorprotocol.cpp
      daemons/collector/src/main.cpp )
  include_directories( daemons/collector/src daemons/collector/src/network )
  add_executable( mon-collector ${mon-collector-headers} ${mon-collector-sources})
  add_daemon(mon-collector)
ENDIF( BUILD_COLLECTOR )

IF( BUILD_NODE )
  MESSAGE ( STATUS "---> Processing node" )
  SET(mon-node-headers
      daemons/node/src/node_st.h
      daemons/node/src/network/ccollectorsmanager.h
      daemons/node/src/network/cremotecollector.h
      daemons/node/src/network/cnodeprotocol.h
  )
  SET(mon-node-sources
      daemons/node/src/network/ccollectorsmanager.cpp
      daemons/node/src/network/cremotecollector.cpp
      daemons/node/src/network/cnodeprotocol.cpp
      daemons/node/src/main.cpp )
  include_directories( daemons/node/src daemons/node/src/network )
  add_executable( mon-node ${mon-node-headers} ${mon-node-sources})
  add_daemon(mon-node)
ENDIF( BUILD_NODE )
# +++++++++++++++++++ applications +++++++++++++++++++
